<!--åŠ è½½logoå›¾ç‰‡-->
<!-- DEBUG MARKER 123 -->
{% load socialaccount %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notifications</title>

    <!-- å¼•å…¥ Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- å¼•å…¥ Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">

    <style>
        /* ğŸŒˆ è®©æ•´ä¸ªç½‘é¡µçš„èƒŒæ™¯å˜æˆæ¸å˜è‰²ï¼Œæå‡è§†è§‰æ•ˆæœ */
        body {
            background: linear-gradient(to right, #84a9ac, #3b6978, #204051); /* æ¸å˜èƒŒæ™¯ */
            color: white; /* è®©æ‰€æœ‰æ–‡æœ¬é»˜è®¤å˜ä¸ºç™½è‰² */
            font-family: Arial, sans-serif; /* ç»Ÿä¸€ç½‘é¡µå­—ä½“ï¼Œä¿è¯ç¾è§‚ */
        }

        /* ğŸ’» è®©æ•´ä¸ªé¡µé¢é€‚åº”å…¨å±ï¼Œè€Œä¸æ˜¯å›ºå®šå®½åº¦ */
        .container-fluid {
            width: 100%; /* è®©ç½‘é¡µå¡«å……æ•´ä¸ªå±å¹• */
            padding: 20px; /* è®¾ç½®å†…è¾¹è·ï¼Œé¿å…å†…å®¹å¤ªç´§å‡‘ */
        }

        /* ğŸ”µ å·¦ä¸Šè§’ LOGO æ ·å¼ */
        .logo-container {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }

        .logo-container img {
            width: 60px; /* LOGO å›¾ç‰‡å¤§å° */
            height: auto;
        }

        .logo-text {
            font-size: 28px;
            font-weight: bold;
        }

        .logo-text span {
            color: #007bff; /* `!` å˜æˆè“è‰² */
        }

        .logo-text .air {
            color: #007bff; /* `Air` å˜æˆè“è‰² */
        }

        /* ç™»å½•æ¡†çš„æ ·å¼ */
        .form-box {
            padding: 30px;
            border-radius: 10px;
            width: 100%;
            max-width: 600px; /* é™åˆ¶æœ€å¤§å®½åº¦ */
            text-align: center;
            margin: auto;
        }

        /* å¤´åƒå ä½ç¬¦æ ·å¼ */
        .profile-pic {
            width: 200px;
            height: 200px;
            border-radius: 50%;
        {#border: 1px solid white;#} display: flex;
            align-items: center;
            justify-content: center;
            margin: 100px auto;
            font-size: 18px;
            font-weight: bold;
            overflow: hidden; /* è®©å›¾ç‰‡æº¢å‡ºéƒ¨åˆ†è¢«è£å‰ª */
        {#background-color: #c2c2c2; /* é»˜è®¤èƒŒæ™¯è‰² */#}
        }

        /* ç”¨æˆ·å¤´åƒå›¾ç‰‡ */
        .profile-pic img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* ç™»å½•å’Œæ³¨å†ŒæŒ‰é’® */
        .btn-log {
            width: 100px;
            font-weight: bold;
            margin: 5px;
            background-color: #2d6786 !important; /* é»˜è®¤æŒ‰é’®é¢œè‰² */
            color: white;
            border: none;
            transition: 0.3s ease-in-out;
        }

        .btn-log:hover {
            background-color: #214e67 !important; /* æ‚¬åœæ—¶é¢œè‰²å˜æ·± */
            color: white;
        }

        .btn-sign {
            width: 100px;
            font-weight: bold;
            margin: 5px;
            background-color: #6c757d !important; /* é»˜è®¤æŒ‰é’®é¢œè‰² */
            color: white;
        }

        .btn-sign:hover {
            background-color: #5a6268 !important; /* æ‚¬åœæ—¶é¢œè‰²å˜æ·± */
            color: white;
        }

        .btn-google {
            background-color: #db4437; /* Googleçº¢ */
            color: white;
            border: none;
        }

        .btn-google:hover {
            background-color: #c23321;
        }

        /* è‡ªå®šä¹‰ç±»ï¼šæ§åˆ¶è¡¨å•å±…ä¸­ + å®½åº¦ */
        .form-container {
            width: 100%;
            max-width: 600px;
            padding: 20px;
            text-align: center;
        {#background: rgba(255, 255, 255, 0.1); /* åŠé€æ˜èƒŒæ™¯ */#} border-radius: 5px;
        {#box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);#} margin: -10px auto; /* æ°´å¹³å±…ä¸­ */
        }

        /* Labelå³å¯¹é½ï¼Œè¾“å…¥æ¡†å·¦å¯¹é½ */
        .col-form-label {
            display: block;
            margin-bottom: 0; /* å‡å°ä¸è¾“å…¥æ¡†çš„é—´è· */
            font-weight: 600;
            color: #ffffff;
            font-size: 13px;
        }

        /* æ ‡ç­¾å’Œè¾“å…¥æ¡†ï¼šæ ‡ç­¾åœ¨ä¸Šï¼Œè¾“å…¥æ¡†åœ¨ä¸‹ï¼Œé—´è·è¾ƒå° */
        .form-group {
            margin-bottom: 0;
            text-align: left; /* å¦‚æœæƒ³è®©æ ‡ç­¾æ–‡å­—å·¦å¯¹é½ï¼Œå¯åŠ ä¸Šè¿™è¡Œ */
        }

        /* ğŸ“© è¾“å…¥æ¡†æ ·å¼ */
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 13px;
        }


        /* ç¦æ­¢ä¸‹åˆ’çº¿ã€æµ…è‰²å­—ä½“ */
        .no-underline {
            text-decoration: none;
            color: #d2d2d2; /* ä½ æƒ³è¦çš„é¢œè‰² */
        }

        /* æ‚¬åœæ—¶å¯åŠ ç‚¹æ•ˆæœ */
        .no-underline:hover {
            color: #ffffff;
        }

        /* è®©â€œRemember Meâ€å±…ä¸­ */
        .remember-center {
            text-align: center;
            margin-top: 2px;
        }

        /* Forgot password é“¾æ¥ */
        .forgot-link {
            float: right;
            margin-top: 2px;
        }

        .forgot-link a {
            text-decoration: none;
            color: #b2b2b2;
        }

        .forgot-link a:hover {
            color: #ffffff;
        }

    </style>
</head>
<body>
<!-- ğŸ“Œ è®©æ•´ä¸ªé¡µé¢ä½¿ç”¨ `container-fluid` é€‚é…å…¨å± -->
<div class="container-fluid mt-4">
    <div class="row">
        <!-- ğŸ”µ å·¦ä¾§éƒ¨åˆ†ï¼ˆLOGO ï¼‰ -->
        <div class="col-lg-3 col-md-4">
            <div class="logo-container">
                <img src="{% static 'images/logo.png' %}" alt="Logo" width="50">
                <h3 class="logo-text ms-2">Go<span>!Air</span></h3>
            </div>
        </div>
    </div>
    <div class="form-box">
        <!-- å¤´åƒå ä½ç¬¦ -->
        <!-- ========== ä¿®æ”¹å¤„ï¼šå¤´åƒå®¹å™¨ï¼Œåˆå§‹ä¸ºé»˜è®¤å¤´åƒ ========== -->
        <div id="profilePic" class="profile-pic">
            <!-- é»˜è®¤æ˜¾ç¤º -->
            <img id="avatarImg" src="{% get_media_prefix %}avatars/default.jpg">
        </div>

        <!-- Allauth ç™»å½•è¡¨å• -->
        <form method="post" id="login-form" action="{% url 'account_login' %}" class="form-container">
            {% csrf_token %}

            <!-- Email -->
            <div class="form-container">
                <div class="form-group">
                    <label for="id_login" class="col-form-label">Email:</label>
                    {{ form.login }}
                    <!-- åŠ  onblur åˆ° input -->
                    <script>
                        // ç»™ Allauth ç”Ÿæˆçš„ input#id_login åŠ ä¸Š onblur äº‹ä»¶
                        // setTimeout æ˜¯ä¸ºäº†ç¡®ä¿ DOM å…ƒç´ å·²æ¸²æŸ“
                        setTimeout(function () {
                            const emailInput = document.getElementById('id_login');
                            if (emailInput) {
                                emailInput.addEventListener('blur', checkUserEmail);
                                emailInput.setAttribute('placeholder', 'Email address');
                            }
                        }, 0);
                    </script>
                </div>
            </div>

            <!-- Password + Forgot link -->
            <div class="form-container">
                <div class="form-group">
                    <label for="id_password" class="col-form-label">Password:</label>
                    {{ form.password }}
                    <script>
                        setTimeout(function () {
                            const passInput = document.getElementById('id_password');
                            if (passInput) {
                                passInput.setAttribute('placeholder', 'Password');
                            }
                        }, 0);
                    </script>

                    <small class="forgot-link">
                        <a href="{% url 'account_reset_password' %}" class="no-underline">
                            Forgot your password?
                        </a>
                    </small>
                </div>
            </div>

            <!-- Remember Me -->
            <div class="form-container">
                <div class="col-12 remember-center">
                    <div class="form-check d-inline-block">
                        {{ form.remember }}
                        <label class="form-check-label" for="id_remember">
                            Remember Me
                        </label>
                    </div>
                </div>
            </div>

            <!-- æŒ‰é’®è¡Œ -->
            {#            <div class="form-container">#}
            <div class="row mb-3">
                <div class="col-12 text-center">
                    <!-- ç™»å½•æŒ‰é’® -->
                    <button type="submit" class="btn btn-log" onclick="checkUserBeforeLogin(event);">Log In</button>

                    <!-- æ³¨å†ŒæŒ‰é’®ï¼šè·³è½¬åˆ° Allauth çš„ /accounts/signup -->
                    <a href="{% url 'account_signup' %}" class="btn btn-sign">Sign up</a>

                    <!-- Google ç™»å½•æŒ‰é’® -->
                    <a href="{% provider_login_url 'google' %}" class="btn btn-google">
                        <i class="bi bi-google"></i> Google
                    </a>
                </div>
            </div>
        </form>
    </div>

</div>
<!-- å¢åŠ  login-message ä»¥æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ -->
<div id="login-message" class="text-center text-danger mt-3"></div>

<!-- ========== ä¿®æ”¹å¤„ï¼šæ¨¡æ€æ¡†ï¼Œæç¤ºâ€œè¦å…ˆæ³¨å†Œâ€ ========== -->
<div class="modal fade" id="registerModal" tabindex="-1" aria-labelledby="registerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content text-dark">
            <div class="modal-header">
                <h5 class="modal-title" id="registerModalLabel">Not Registered</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>This email is not registered. Please sign up first.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-sign" data-bs-dismiss="modal">Cancel</button>
                <a href="{% url 'signup' %}" class="btn btn-log">Sign up</a>
            </div>
        </div>
    </div>
</div>
{#<div class="text-center" style="margin-top: 20px;">#}
{#    <button class="btn btn-primary m-2"#}
{#            onclick="bootstrap.Modal.getOrCreateInstance(document.getElementById('registerModal')).show()">#}
{#        Show register Modal#}
{#    </button>#}
{#</div>#}
<!-- ğŸ“Œ å¼•å…¥ Bootstrap 5.3 JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function checkUserBeforeLogin(event) {
    event.preventDefault(); // é˜»æ­¢é»˜è®¤æäº¤è¡Œä¸º
    document.getElementById('login-form').submit(); // æ‰‹åŠ¨æäº¤è¡¨å•
}

    function checkUserEmail() {
    const emailInput = document.getElementById('id_login') ? document.getElementById('id_login').value.trim() : "";
    if (!emailInput) {
        console.error("No email provided");
        return;
    }
    
     const email = emailInput.value.trim();
    if (!email) {
        console.error("No email provided");
        return;
    }

    fetch(`/api/check_user/?email=${encodeURIComponent(email)}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log("API Response:", data); // ğŸ”´ æ£€æŸ¥ API å“åº”
            if (data.found) {
                document.getElementById('avatarImg').src = data.avatar_url || "{{ media_url }}avatars/default.jpg";
            } else {
                document.getElementById('avatarImg').src = "{{ media_url }}avatars/default.jpg";

                let modal = document.getElementById('registerModal');
                if (modal) {
                    let bootstrapModal = new bootstrap.Modal(modal);
                    bootstrapModal.show();
                    console.log("Modal should be shown"); // ğŸ”´ è®°å½•æ—¥å¿—
                } else {
                    console.error("Modal not found");
                }
            }
        })
        .catch(error => {
            console.error("Error checking user:", error);
        // ç¡®ä¿ modal ä»ç„¶èƒ½æ˜¾ç¤º
            let modal = document.getElementById('registerModal');
            if (modal) {
                let bootstrapModal = new bootstrap.Modal(modal);
                bootstrapModal.show();
            }
        });
}

   document.getElementById('login-form').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const data = {
        login: formData.get('login'),  // ç¡®ä¿åŒ¹é… Django Allauth
        password: formData.get('password'),
        remember: formData.get('remember') ? "on" : "off"
    };
    
    console.log("Submitting data:", data); // è°ƒè¯•æ—¥å¿—

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch('/accounts/login/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.token) {
            document.getElementById('login-message').innerText = 'Login Successfulï¼';
            window.location.href = '/user_page'; // ç™»å½•æˆåŠŸåè·³è½¬
        } else {
            document.getElementById('login-message').innerText = 'Login Failureï¼š' + (result.detail || 'unknown error');
        }
    })
    .catch(error => {
        console.error('Login Failureï¼š', error);
        document.getElementById('login-message').innerText = 'Login Failure, Network Error';
    });
});
</script>
</body>
</html>
